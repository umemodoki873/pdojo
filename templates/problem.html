<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ problem.title }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <style>
      /* Monaco Editor ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼šã‚¨ãƒ‡ã‚£ã‚¿ã®é«˜ã•ã‚„ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è¨­å®š */
      #codeEditor {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">Pé“å ´</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="{{ url_for('index') }}"
                >ãƒ›ãƒ¼ãƒ </a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="{{ url_for('support') }}"
                >ã‚°ãƒƒã‚ºã§å¿œæ´</a
              >
            </li>
            {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('submissions') }}"
                >æå‡ºå±¥æ­´</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('register') }}"
                >ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</a
              >
            </li>
            {% endif %}
            <!-- å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ  -->
          </ul>
        </div>
      </div>
    </nav>

    <div class="container my-5">
      <!-- å•é¡Œæ–‡ -->
      <div class="mb-5">
        <h1 class="display-4">{{ problem.title }}</h1>
        <!-- å•é¡Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼ˆå•é¡Œãã®ã‚‚ã®ã«å¯¾ã™ã‚‹è©•ä¾¡ï¼‰ -->
        <div class="mb-2">
          <button
            class="btn btn-sm btn-outline-success"
            onclick="sendFeedback('problem', '{{ problem.id }}', 'good')"
          >
            Good
          </button>
          <button
            class="btn btn-sm btn-outline-danger"
            onclick="sendFeedback('problem', '{{ problem.id }}', 'bad')"
          >
            Bad
          </button>
        </div>
        <p class="lead">{{ problem.description }}</p>
      </div>

      <!-- ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º -->
      <div class="mb-5">
        <h2>ã‚µãƒ³ãƒ—ãƒ«</h2>
        {% for test in problem.test_cases %}
        <div class="card mb-3">
          <div class="card-header">ã‚µãƒ³ãƒ—ãƒ« {{ loop.index }}</div>
          <div class="card-body">
            <h5 class="card-title">å…¥åŠ›ä¾‹</h5>
            <pre>{{ test.input_data }}</pre>
            <h5 class="card-title">å‡ºåŠ›ä¾‹</h5>
            <pre>{{ test.expected_output }}</pre>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- ã‚³ãƒ¼ãƒ‰æå‡ºãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="mb-5">
        <h2>ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã™ã‚‹</h2>
        <form
          id="codeForm"
          action="{{ url_for('submit', problem_id=problem_id) }}"
          method="post"
        >
          <!-- Monaco Editor ã‚’é…ç½®ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
          <div id="codeEditor"></div>
          <input type="hidden" id="hiddenCode" name="code" />
          <button type="submit" class="btn btn-primary">æå‡º</button>
        </form>
      </div>

      <!-- æå‡ºçµæœï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ -->
      {% if results is defined %}
      <div class="mb-5">
        <h2>æå‡ºçµæœï¼š{{ overall }}</h2>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹</th>
                <th>å…¥åŠ›</th>
                <th>æœŸå¾…ã™ã‚‹å‡ºåŠ›</th>
                <th>ã‚ãªãŸã®å‡ºåŠ›</th>
                <th>åˆ¤å®š</th>
                <th>ã‚¨ãƒ©ãƒ¼</th>
              </tr>
            </thead>
            <tbody>
              {% for i, result in enumerate(results, 1) %}
              <tr>
                <td>{{ i }}</td>
                <td><pre>{{ result.input }}</pre></td>
                <td><pre>{{ result.expected }}</pre></td>
                <td><pre>{{ result.output }}</pre></td>
                <td>
                  {% if result.status == "Accepted" %}
                  <span class="badge bg-success">{{ result.status }}</span>
                  {% elif result.status == "Wrong Answer" %}
                  <span class="badge bg-danger">{{ result.status }}</span>
                  {% else %}
                  <span class="badge bg-warning text-dark"
                    >{{ result.status }}</span
                  >
                  {% endif %}
                </td>
                <td><pre>{{ result.error }}</pre></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}<!-- GPT ãƒ’ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
      <!-- ãƒ’ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
      {% if hint_prompt %}
      <div class="alert alert-warning mt-4">
        <h4>ãƒ’ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h4>
        <p>{{ hint_prompt }}</p>
        {% if not current_user.is_authenticated %}
        <p class="text-danger small mb-2">
          â€» ãƒ’ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
        </p>
        {% endif %} {# â‘¡ æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ– #}
        <button
          id="getHintButton"
          class="btn btn-sm btn-info"
          onclick="requestHint()"
          {%
          if
          not
          current_user.is_authenticated
          %}disabled{%
          endif
          %}
        >
          ãƒ’ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†
        </button>
      </div>
      {% endif %}

      <!-- ãƒ’ãƒ³ãƒˆè¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div
        id="hint-container"
        class="alert alert-info mt-4"
        style="display: none"
      >
        <div
          id="support-call"
          class="alert alert-secondary mt-3"
          style="display: none"
        >
          <p class="mb-2">
            ğŸ™ GPTãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€ã”æ”¯æ´ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ï¼
          </p>
          <a
            href="{{ url_for('support') }}"
            class="btn btn-sm btn-outline-success"
          >
            æ”¯æ´ãƒšãƒ¼ã‚¸ã¸
          </a>
        </div>
        <h4>GPT ãƒ’ãƒ³ãƒˆ</h4>
        <p id="hint-text"></p>
        <!-- ãƒ’ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ -->
        <div>
          <button
            class="btn btn-sm btn-outline-success"
            onclick="sendFeedback('hint', '{{ problem.id }}', 'good')"
          >
            Good
          </button>
          <button
            class="btn btn-sm btn-outline-danger"
            onclick="sendFeedback('hint', '{{ problem.id }}', 'bad')"
          >
            Bad
          </button>
        </div>
      </div>

      <a href="{{ url_for('index') }}" class="btn btn-secondary"
        >å•é¡Œä¸€è¦§ã¸æˆ»ã‚‹</a
      >
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>
    <!-- Monaco Editor ã® AMD ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>
    <script>
      // Flask ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ user_code ã‚’ JS å¤‰æ•°ã«æ ¼ç´
      const initialCode = {{ user_code|tojson }};
      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs",
        },
      });
      require(["vs/editor/editor.main"], function () {
        // Monaco Editor ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        var editor = monaco.editor.create(
          document.getElementById("codeEditor"),
          {
            value: initialCode, // åˆæœŸå€¤ã‚’å–å¾—
            language: "python",
            theme: "vs-light", // ã¾ãŸã¯ 'vs-dark'
          }
        );

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«ã€Monaco ã®å†…å®¹ã‚’ hidden input ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
        document
          .getElementById("codeForm")
          .addEventListener("submit", function () {
            document.getElementById("hiddenCode").value = editor.getValue();
          });
      });
    </script>
    <script>
      function sendFeedback(targetType, targetId, feedback) {
        fetch("{{ url_for('submit_feedback') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            target_type: targetType,
            target_id: targetId,
            feedback: feedback,
          }),
        })
          .then((response) => {
            if (response.ok) {
              alert("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚");
            } else {
              alert("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          });
      }
    </script>
    <script>
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰hint_paramsã‚’JSONã¨ã—ã¦å—ã‘å–ã‚‹
          var hintParams = {{ hint_params|default({})|tojson }};
          console.log("Hint parameters:", hintParams);


      function requestHint() {
        const params = new URLSearchParams({
          problem_id: "{{ problem.id }}",
          code: {{ user_code|tojson }},
          error_type: hintParams.error_type || "",
          error_message: hintParams.error_message || "",
          input_example: hintParams.input_example || "",
          output_example: hintParams.output_example || "",
          problem_description: hintParams.problem_description || ""
        });

        fetch("{{ url_for('use_hint_route') }}", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          credentials: "include"               // â† â† â† ã“ã‚Œã‚‚å¿˜ã‚Œãšä»˜ã‘ã‚‹
        })
          .then(res => {
            /* â‘  æœªãƒ­ã‚°ã‚¤ãƒ³ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸã‚‰ HTML ãŒè¿”ã‚‹ */
            const isJson = res.headers.get("content-type")?.includes("application/json");
            if (!isJson) {
              /* /login ã«é£›ã°ã—ã¦ã€æˆ»ã£ãŸã‚‰åŒã˜ãƒšãƒ¼ã‚¸ã‚’å†è¡¨ç¤º */
              window.location.href = "/login?next=" + encodeURIComponent(location.pathname);
              return Promise.reject();         // ä»¥é™ã® then ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }
            return res.json();
          })
          .then(data => {
            if (!data) return;                // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã¯ä½•ã‚‚ã—ãªã„
            if (data.status === "success") {
              document.getElementById("hint-text").innerText = data.hint;
            } else {
              document.getElementById("hint-text").innerText =
                "ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + data.message;
                if (data.code === "quota") {
                  document.getElementById("support-call").style.display = "block";
                }
            }
            document.getElementById("hint-container").style.display = "block";
          })
          .catch(err => {                     // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾‹å¤–ãªã©
            console.error(err);
            document.getElementById("hint-text").innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            document.getElementById("hint-container").style.display = "block";
          });
      }
    </script>
  </body>
</html>
